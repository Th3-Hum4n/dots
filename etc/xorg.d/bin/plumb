#!/bin/sh
# try to act like plan9's plumber

THING=`xclip -sel 'primary' -o`
DN=`mktemp`
# DIRS="${HOME}/bin ${HOME}/etc/xorg.d ${HOME}/etc/emacs.d \
#     ${HOME}/usr/doc ${HOME}/usr/share ${HOME}/usr/src"

less() {
    exec st -g 80x40+100+100 -e less ${1}
}

open() {
    case `file -ib ${1}` in
    (image/*)    exec meh     ${1} ;;
    (text/x-sc*) exec less    ${1} ;;
    (text/plain) exec less    ${1} ;;
    (app*/pdf)   exec zathura ${1} ;;
    (audio/*)    exec mpv -   ${1} ;;
    (video/*)    exec mpv -   ${1} ;;
    esac
}

http() {
    content=`curl -I ${THING} | grep Content-Type`
    case ${content##*:} in
    (text/html) exec palemoon --new-window "${THING}" ;;
    (*)         curl -o ${DN}; open ${DN}             ;;
    esac
    unset content
}

man() {
    name=${THING%%\(*}
    sect=${THING##*\(}
    sect=${sect%%\)*}

    apropos ${name} > /dev/null
    [ ${?} -ne 0 ] && return 1
    exec st -g 80x40+100+100 -e man ${sect} ${name}
}

# is_file() {
#     [ -f "${1}" ] && return 0
#     find "${DIRS}" -type f \
#          -iname "*${1}*" > /dev/null && return 0
#     return 1
# }
#
# is_dir() {
#     [ -d "${1}" ] && return 0
#     find "${DIRS}" -type d \
#          -iname "*${1}*" > /dev/null && return 0
#     return 1
# }

other() {
    if [ -f "${THING}" ]; then
        open "${THING}"
    elif [ -d "${THING}" ]; then
        echo dir
        st -e sh -c "cd ${THING} && ksh"
    elif echo "${THING}" | grep -e '[a-zA-z]\([0-9a-z]\)' > /dev/null; then
        man
        [ ${?} -eq 1 ] && palemoon --new-window --search "${THING}"
    else
        palemoon --new-window --search "${THING}"
    fi
}

case ${THING} in
(http[s]://*) http  ;;
(*)           other ;;
esac

[ -f ${DN} ] && rm ${DN}
