#!/bin/ksh
# ls and cd in dmenu
# -h 1 = hide dotfiles

case ${1} {
(-h) hidden=$2;;
(*) hidden=1;;
}

ls() {
    local result
    local i
    for i in *; {
        [[ -d "${i}" ]] && i="${i}/"
        result="${result}\n${i}"
    }

    echo ${result}
}

get_dir() {
    case ${hidden} {
    (1) echo "..$(ls)" | menu sel -p ${PWD/~/\~} ;;
    (0) echo "..$(ls)" | menu sel -p ${PWD/~/\~} ;;
    }
}

cd_dir() {
    cd "${1}"
    spawn
}

open_file() {
    case `file -ib ${1}` {
    (*pdf*)   zathura     "${1}" ;;
    (*image*) sxiv        "${1}" ;;
    (*video*) mpv         "${1}" ;;
    (*text*)  emacsclient "${1}" ;;
    (*)
        case `file "${1}"` {
        (*archive*)
            st -e upkp "${1}";;
        };;
    }
}

spawn() {
    local output="$(get_dir)"

    [[ -d "${output}" ]] &&
        cd_dir "${output}"
    [[ -f "${output}" ]] &&
        open_file "${output}"
}

spawn
