#!/bin/dash
trap 'pkill -P $$' EXIT

init() {
    remkd /tmp/info/bar

    while ! pgrep dwm > /dev/null ; do
        sleep 0.1
    done

    h=$(cat /tmp/info/dwm/bar/height)

    [ ${h} -eq 0 ] && exit

    local sh=$(res -h)
    x=0
    y=$((sh - h))
    w=$(res -w)

	vol -i 0
}

wksp() {
    local i=1
    while [ ${i} -le $(cat /tmp/info/dwm/tag/num) ]; do
        # check if occupied
        local state=$(cat /tmp/info/dwm/tag/${i})
        if [ ${state} -eq 1 ]; then
            ws="x "
        elif [ ${state} -eq 2 ]; then
            ws="@ "
        else
            ws="+ "
        fi

        # check if current
        [ $(cat /tmp/info/dwm/tag/current) -eq ${i} ] &&
            ws="* "

        buffer="${buffer}${ws}"
        i=$((i + 1))
    done
    echo "${buffer}" > /tmp/info/bar/wksp
} 2> /dev/null

title() {
    shorten() {
        echo `echo "${@}" | cut -c1-40`...
    }

    local winn="$(xdotool getactivewindow getwindowname | tr '[:upper:]' '[:lower:]')"
    local formatname=""

    remove_name() {
        echo "${winn}" | sed -e "s/ - $1//"
    }

    case ${winn} in
    (*" - chromium"*) winn="chromium: `remove_name "chromium"`";;
    (*" - firefox"*) winn="ff: `remove_name "firefox"`";;
    esac

    [ ${#winn} -ge 40 ] && winn=`shorten "${winn}"`
    [ -n "${winn}" ] && formatname=" ${winn} "
    echo "${formatname}"
}


launchd() {
    timed() {
        while date "+%H:%M" > /tmp/info/bar/time; do
            sleep 59
        done
    }

    dated() {
        while echo "$(date +'%b %d' | tr '[:upper:]' '[:lower:]')" \
            > /tmp/info/bar/date; do
            sleep 300
        done
    }

    dayd() {
        while \
            echo $(date +%a | tr '[:upper:]' '[:lower:]' | cut -c1-2) \
            > /tmp/info/bar/day; do
            sleep 300
        done
    }

    batd() {
        [ `bat -s` = "Unknown" ] && return; [ `bat -s` = "Charging" ] && ind="^"
        while echo "`bat -p`%${ind}" > /tmp/info/bar/bat; do
            sleep 5
        done
    }

    local d; for d in timed dated dayd batd; do $d & done
}

init; launchd

while echo                                           \
         "%{l}  $(cat /tmp/info/bar/day) "           \
		 " $(title)"                                 \
         "%{c}"                                      \
		 "$(wksp) $(cat /tmp/info/bar/wksp)"         \
         "%{r}$(cat /tmp/info/bar/bat 2> /dev/null)" \
         "$(cat /tmp/info/vol/cur)% "                \
         "$(cat /tmp/info/bar/time) "                \
         "$(cat /tmp/info/bar/date)  "
    do sleep 0.5; done 2> /dev/null                  |
lemonbar -db                                         \
         -f 'ttyp0:pixelsize=9'                      \
         -g ${w}x${h}+${x}+${y}                      \
         -n bar                                      \
         -B '#ffffff'                                \
         -F $(cat /tmp/info/dwm/colors/normfg)       > /dev/null 2>&1
