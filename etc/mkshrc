#!/bin/mksh
# vim:ft=sh
case $- { (*i*) ;; (*) return;; }

. $HOME/etc/aliases

alias echo='builtin print'
alias !!='\\builtin fc -e -'

set -o vi-tabcomplete
set -o nohup bgnice trackall

unalias r w

# dont freeze the shell when C-s is pressed
stty -ixon

# history
HISTFILE="$HOME/var/cache/mksh_history"
HISTSIZE=100000

# vi mode
set -o vi

# check the current git branch
_branch() {
    local branch="$(git branch | grep \* | tr -d '*')"

    [ -z $branch ] && return

    case "$(git status -uno 2> /dev/null)" {
        (*"Changes to be committed"* | *"not staged"*) echo -n "${branch}+";;
        (*"ahead of"*) echo -n "${branch}^";;
        (*"up to date"*) echo -n "${branch}";;
        (*) echo -n "${branch}";;
    }
} 2> /dev/null

_set_wn() {
    [ "$TERM" != "linux" ] && {
        local cwd="${PWD/$HOME/\~}"
        echo -ne "\033]0;mksh: $cwd\a"
    }
} 2> /dev/null

# delete Desktop folder
# I HATE IT
_rm_jnk() {
    [ -d $XDG_DESKTOP_HOME ] && rm -rf $XDG_DESKTOP_HOME
    [ -d $HOME/Desktop ] && rm -rf $HOME/Desktop
    [ -d $HOME/Downloads ] &&
        [ -z "$(ls $HOME/Downloads)" ] && rm -rf $HOME/Downloads
    # im not sure if this is safe but hey, I hate them
    [ -d $HOME/.dbus ] && rm -rf $HOME/.dbus
    [ -d $HOME/.pki ] && rm -rf $HOME/.pki
    [ -f $HOME/.wget-hsts ] && rm -rf $HOME/.wget-hsts
} > /dev/null

_PS1_details() {
    echo -ne "\033[38;5;5m$(_branch)\033[0m"
}

_PS1_command() {
    _set_wn; _rm_jnk
}

_get_cwd() {
    echo -ne "${PWD/$HOME/\~}"
}

# prompts
#export PS1=']$(_PS1_details)$(_PS1_command) '
export PS1='\$$(_PS1_details)$(_PS1_command) '
#export PS1='%$(_PS1_command &)$(_PS1_details) '
PS2='... '

# console stuff
[ "$TERM" = "linux" ] && {
    [ -f $XDG_CACHE_HOME/tm/tty.sh ] &&
        source $XDG_CACHE_HOME/tm/tty.sh

    clear
    [ $(brness -g) -gt 20 ] && sudo brness -s 20%
} 2> /dev/null
