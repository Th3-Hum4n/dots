#!/bin/dash
# a todo list thingy manager in dash
# set the cache folder
[ -n $(echo "$XDG_CACHE_HOME") ] && cache="$XDG_CACHE_HOME/todo"\
    || cache="$HOME/.cache/todo"

add_entry() {
    echo "$@" >> "${cache}"
}

delete_entry() {
    local line_num="$1"
    # assuming the line number is from the beginning, get that entry
    local entry="$(sed -n "${line_num}p" "${cache}")"

    sed -i "/${entry}/d" "${cache}"
}

show() {
    local i=1
    local num_entries=$(cat "${cache}" | wc -l)

    while [ $i -le $num_entries ]; do
        echo "${i} `sed -n "${i}p" "${cache}"`"
        i=$((i+1))
    done
}

edit_entry() {
    for tmp in $@; do
        local line_num="$tmp"
        break
    done
    local old_entry="$(sed -n "${line_num}p" "${cache}")"
    local new_entry="$(echo "$@" | sed -n -e "s/${line_num} //")"

    # replace old_entry
    sed -n -i "s/${old_entry}/${new_entry}/g" "${cache}"

    unset tmp
}

usage() {
    case "$1" in
        interactive)
            echo "a(dd) entry -> add new entry"
            echo "s(how) or p(rint) -> print the list"
            echo "d(elete) n -> delete nth entry"
            echo "e(dit) n str -> replace nth entry with str"
            echo "q(uit) or e(xit) -> quit";;
        prompt)
            echo "usage\n---------------"
            echo "[-a entry] add new entry to todo list"
            echo "[-s] show all entries"
            echo "[-p] show all entries"
            echo "[-i] interactive mode"
            echo "[-e n str] replace nth entry with str"
            echo "[-d n] delete the nth entry"
            echo "[-h] print this help message";;
    esac
}

interactive() {
    while true; do
        read -p "> " input

        # only get the first word
        for i in $input; do
            local func="$i"
            break
        done

        # let's modify the input to remove the function
        input=`echo "$input" | sed -e "s/${func}//"`

        case "$func" in
            s|p|show|print) show;;
            a|add) add_entry "$(echo "$input" | sed -e 's/ //')";;
            d|delete) delete_entry "$input";;
            e|edit)
                for i in $input; do
                    local tmp=$i
                    break
                done
                edit_entry "$tmp" "$(echo "$input" | sed -e "s/ $tmp //")";;
            q|quit) exit 0;;
            c|clear) rm -rf ${cache};;
            h|?) usage interactive;;
            *) usage interactive;;
        esac
    done

    unset i
}

case "$1" in
    -h) usage prompt;;
    -a) shift; add_entry "$@";;
    -d) delete_entry "$2";;
#    -e) tmp="$2"; shift 2; echo "$@"; edit_entry "$tmp" "$@";;
    -s|-p) show;;
    -i) interactive;;
    *) interactive;;
esac
