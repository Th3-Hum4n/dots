#!/bin/sh
# music

sock=/tmp/mussock
! pgrep -x mpv > /dev/null && [ -S ${sock} ] && rm ${sock}
cmd="socat - ${sock}"

men() {
    echo 'next\nprev\nshuff\npause' | menu sel
}

fmt_song() {
    artist=${1%/*}
    artist=`echo ${artist##*/} | tr _ ' '`
    song=`echo ${1##*/} | tr _ ' '`

    printf '%s - %s' "${artist}" "${song}"
    unset artist song
}

next() {
    echo '{"command":["playlist-next"]}' | ${cmd} > /dev/null
}

prev() {
    echo '{"command":["playlist-prev"]}' | ${cmd} > /dev/null
}

shuff() {
    echo '{"command":["playlist-shuffle"]}' | ${cmd} > /dev/null
}

cur() {
    cur=`echo '{"command":["get_property_string","path"]}' | ${cmd} \
              | sed -E 's/.*"data":"?([^,"]*)"?.*/\1/'`
    fmt_song ${cur}
    unset cur
}

pause() {
    stat=true
    dat=`echo '{"command":["get_property","pause"]}' | ${cmd}`
    case ${dat} in
    (*true*) stat=false ;;
    esac
    printf '{"command":["set_property","pause",%s]}\n' ${stat} | ${cmd} > /dev/null
    unset stat dat
}

quit() {
    echo '{"command":["quit"]}' | ${cmd} > /dev/null
}

perc() {
    dur=`echo '{"command":["get_property","duration"]}' | ${cmd} | grep -o -E '[0-9.]+'`
    cur=`echo '{"command":["get_property","time-pos"]}' | ${cmd} | grep -o -E '[0-9.]+'`
    echo "${cur} * 100 / ${dur}" | bc
}

pprint() {
    [ -S ${sock} ] || {
        echo "not playing!"
        exit 0
    }
    printf 'playing: %s (%s%%)\n' "`cur`" "`perc`"
}

! pgrep -x mpv > /dev/null && [ ${#} -eq 0 ] &&
    mpv --no-audio-display              \
        --input-ipc-server=${sock}      \
        --shuffle                       \
        `find ${HOME}/var/music -type f`

${1:-`men`}
