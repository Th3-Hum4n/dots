#!/bin/sh

sock=/tmp/mussock
cmd="socat - ${sock}"

men() {
	echo 'pause \nnext \nprev \nshuff \nquit' | menu sel
}

fmt_song() {
	artist=${1%/*}

	echo "`echo ${artist##*/} | tr _ ' '` - `echo ${1##*/} | tr _ ' '`"
	unset artist
}

next() {
	echo '{"command":["playlist-next"]}' | ${cmd} >/dev/null
}

prev() {
	echo '{"command":["playlist-prev"]}' | ${cmd} >/dev/null
}

shuff() {
	echo '{"command":["playlist-shuffle"]}' | ${cmd} >/dev/null
}

curfile() {
	f=`echo '{"command":["get_property_string","path"]}' | ${cmd}`
	f="${f##*\"data\":\"}"
	echo "${f%%\"*}"
	unset f
}

is_playing() {
	dat=`echo '{"command":["get_property","pause"]}' | ${cmd}`
	case ${dat} in 
	*true*) exit 1 ;;
	esac
	exit 0
}

pause() {
	stat=true
	dat=`echo '{"command":["get_property","pause"]}' | ${cmd}`
	case ${dat} in
	*true*) stat=false ;;
	esac
	printf '{"command":["set_property","pause",%s]} \n' ${stat} | ${cmd} >/dev/null
	unset stat dat
}

quit() {
	echo '{"command":["quit"]}' | ${cmd} >/dev/null
	rm ${sock}
	rm /tmp/musplist
}

perc() {
	dur=`echo '{"command":["get_property","duration"]}' | ${cmd}`
	dur=${dur##*\"data\":}
	cur=`echo '{"command":["get_property","time-pos"]}' | ${cmd}`
	cur=${cur##*\"data\":}
	echo "${cur%%,*} * 100 / ${dur%%,*}"# | bc
}

pprint() {
	[ -S ${sock} ] || {
		echo 'not playing!'
		exit 0
	}
	echo "playing: `fmt_song $(curfile)` (`perc`%)"
}

deadsock() {
	! :| ${cmd} 2>/dev/null
}

# trap 'quit' EXIT INT TERM KILL HUP

deadsock && quit

[ ! -S ${sock} ]&& [ ${#} -eq 0 ] && {
	find ${HOME}/usr/share/mus ! -name '*\.*' -type f >/tmp/musplist
	mpv --no-audio-display \
		--input-ipc-server=${sock} \
		--shuffle \
		--playlist=/tmp/musplist
	exit 0
}

if [ -z ${1} ]; then
	`men`
else
	f=${1}
	shift
	${f} ${@}
fi
