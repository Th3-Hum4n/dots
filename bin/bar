#!/bin/dash
# on exit, kill all children
trap 'pkill -P $$' EXIT
LC_ALL=""

init() {
    # get colors
    . $HOME/var/cache/tm/colors/colors.sh

    colorwscurrent=$color5

    [ -d /tmp/bar ] && rm -rf /tmp/bar
    mkdir -p /tmp/bar

    # wait for dwm to start
    while ! pgrep dwm > /dev/null ; do
        sleep 0.1
    done

    # if zero, bar is disabled
    [ $(cat /tmp/dwm_info/bar_height) -eq 0 ] && exit

    echo 1 > /tmp/dwm_info/check

    # geometry
    w=$(res -w)
    local sh=$(res -h)
    h=$(cat /tmp/dwm_info/bar_height)
    x=0
    y=$(( sh - h ))

    # fonts
    #ft="cherry:pixelsize=10"
    ft='scientifica:pixelsize=11:style=bold'

	# get the current volume
	$HOME/bin/vol -i 0
}

layout() {
    case $(cat /tmp/dwm_info/current_layout) in
        0) echo "[]=" ;; # tiled
        1) echo "<><" ;; # floating
        2) echo "[M]" ;; # monocle
        3) echo "===" ;; # bstack
        4) echo "[]H" ;; # deck
        5) echo "|M|" ;; # center master
        6) echo "@" ;; # spiral
        7) echo "//" ;; # dwindle
    esac 2> /dev/null
}

wksp() {
    if [ $(cat /tmp/dwm_info/check) -eq 1 ] ; then
        local i=1
        while [ $i -le $(cat /tmp/dwm_info/num_ws) ]; do
            [ $(cat /tmp/dwm_info/ws"$i") -eq 1 ] && ws=" $i " || ws=""

            [ $(cat /tmp/dwm_info/current_ws) -eq $i ] &&
                ws=" %{F$colorwscurrent}$i%{F-} "

            buffer=$buffer$ws
            i=$((i+1))
        done
        echo -n "$buffer" > /tmp/bar/wksp
    fi 2> /dev/null
}

get_bat() {
    local percent=`$HOME/bin/bat -p`
    local status=`$HOME/bin/bat -s`
    [ ${status} = "Charging" ] && color=$color1 || color=$color7
    [ ${status} != "Unknown" ] && echo "$percent%" > /tmp/bar/bat || touch /tmp/bar/bat
    unset color
}

focused_window() {
    local winn="$(xdotool getactivewindow getwindowname | tr '[:upper:]' '[:lower:]')"
    local lenwinn=${#winn}
    local formatname=""

    [ ${lenwinn} -ge 60 ] && winn="`echo "$winn" | cut -b 1-55`..."
    [ -n "${winn}" ] && formatname=" $winn "
    echo $formatname
}


launch_daemons() {
	# time_daemon
    dash -c 'while true; do
        date "+%H:%M" > /tmp/bar/time
        sleep 59
    done' > /dev/null 2>&1 &

    # date_daemon
    dash -c 'while true; do
        cur_month="$(date +%b | tr [:upper:] [:lower:])"
        cur_date="$(date +%d)"
        echo "$cur_month $cur_date" > /tmp/bar/date
        sleep 300
    done' &

    # day_daemon
    dash -c 'while true; do
        case $(date +%u) in
            1) echo mo > /tmp/bar/day;;
            2) echo tu > /tmp/bar/day;;
            3) echo we > /tmp/bar/day;;
            4) echo th > /tmp/bar/day;;
            5) echo fr > /tmp/bar/day;;
            6) echo sa > /tmp/bar/day;;
            7) echo su > /tmp/bar/day;;
        esac
        sleep 300
    done' &
}

init
launch_daemons

while \
    printf "%s%b%s%b%b%b%b%b%b%s\\n" \
        "%{l} ]  $(cat /tmp/bar/day) "\
        "$(wksp) $(cat /tmp/bar/wksp) " \
        "$(layout) "\
        " $(cat /tmp/ytpl_title)   "\
        "%{c}  $(focused_window)"\
        "%{r}" \
        "$(get_bat)$(cat /tmp/bar/bat)" \
        " $(cat /tmp/bar/vol)% "\
        " $(cat /tmp/bar/time) "\
        " $(cat /tmp/bar/date) "
    do sleep 0.5
done 2> /dev/null | \

lemonbar -db \
         -f "$ft" \
         -g ${w}x${h}+${x}+${y} \
         -n bar \
         -B $color0 \
         -F $color7 \
         -S > /dev/null 2>&1
