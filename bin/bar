#!/bin/dash
trap 'pkill -P $$' EXIT

init() {
    . $HOME/var/cache/tm/colors.sh

    [ -d /tmp/bar ] && rm -rf /tmp/bar; mkdir -p /tmp/bar

    while ! pgrep dwm > /dev/null ; do
        sleep 0.1
    done

    [ $(cat /tmp/dwm_info/bar_height) -eq 0 ] && exit

    echo 1 > /tmp/dwm_info/check

    local sh=$(res -h)
    h=$(cat /tmp/dwm_info/bar_height)
    x=0
    y=$(( sh - h ))
    w=$(res -w)

    ft='cherry:pixelsize=11'
	vol -i 0
}

wksp() {
    [ $(cat /tmp/dwm_info/check) -eq 1 ]  && {
        local i=1
        while [ ${i} -le $(cat /tmp/dwm_info/num_ws) ]; do
            # check if occupied
            [ $(cat /tmp/dwm_info/ws${i}) -eq 1 ] && ws="%{F${color5}}+ %{F-}" || ws="+ "

            # check if current
            [ $(cat /tmp/dwm_info/current_ws) -eq $i ] &&
                ws="* "

            buffer="${buffer}${ws}"
            i=$((i+1))
        done
        echo "${buffer}" > /tmp/bar/wksp
    } 2> /dev/null
}

title() {
    shorten() {
        echo `echo "${@}" | cut -c1-40`...
    }

    [ -S /tmp/mpv_ytpl.socket ] && [ -f /tmp/ytpl_title ] && {
        yt_title=$(cat /tmp/ytpl_title)

        [ ${#yt_title} -ge 40 ] && yt_title="$(shorten "${yt_title}")"

        echo "${yt_title}"
        return
    }

    local winn="$(xdotool getactivewindow getwindowname | tr '[:upper:]' '[:lower:]')"
    local formatname=""

    remove_name() {
        echo "${winn}" | sed -e "s/ - $1//"
    }

    case "${winn}" in
        (*" - chromium"*) winn="chromium: `remove_name "chromium"`";;
        (*" - firefox"*) winn="ff: `remove_name "firefox"`";;
    esac

    [ ${#winn} -ge 40 ] && winn=`shorten "${winn}"`
    [ -n "${winn}" ] && formatname=" ${winn} "
    echo "${formatname}"
}


launchd() {
    timed() {
        while date "+%H:%M" > /tmp/bar/time; do
            sleep 59
        done
    }

    # date_daemon
    dated() {
        while echo "$(date +'%b %d' | tr '[:upper:]' '[:lower:]')" \
            > /tmp/bar/date; do
            sleep 300
        done
    }

    # day_daemon
    dayd() {
        while \
            echo $(date +%a | tr '[:upper:]' '[:lower:]' | cut -c1-2) \
            > /tmp/bar/day; do
            sleep 300
        done
    }

    batd() {
        [ `bat -s` = "Unknown" ] && return; [ `bat -s` = "Charging" ] && ind="^"
        while echo "`bat -p`%${ind}" > /tmp/bar/bat; do
            sleep 5
        done
    }

    local d; for d in timed dated dayd batd; do $d & done
}

init; launchd

while \
    echo "%{l} $(title)" \
         "%{r}" \
         "$(wksp) $(cat /tmp/bar/wksp) " \
         "$(cat /tmp/dwm_info/current_layout) " \
         "%{B${color5}}%{F${color0}}" \
         "$(cat /tmp/bar/bat 2> /dev/null)" \
         "$(cat /tmp/bar/vol)% " \
         " $(cat /tmp/bar/day) " \
         " $(cat /tmp/bar/time) " \
         " $(cat /tmp/bar/date) %{B-}%{F-}"
    do sleep 0.5; done 2> /dev/null | \
lemonbar -db \
         -f ${ft} \
         -g ${w}x${h}+${x}+${y} \
         -n bar \
         -B ${color0} \
         -F ${color7} \
         -S > /dev/null 2>&1
