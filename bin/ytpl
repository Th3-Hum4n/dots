#!/bin/dash
# youtube "playlist" player
# the videos are stored in a plain text file separated with new lines
# I use this script to play music and not videos, so ytdl will only download audio
default_plpath="$HOME/etc/ytplaylist"
socket="/tmp/mpv_ytpl.socket"

set_prop() {
    echo "{ \"command\": [\"set_property\", ${@}] }" | socat - ${socket}
}

get_prop() {
    echo "{ \"command\": [\"get_property\", ${@}] }" | socat - ${socket}
}

play() {
    local file="${1}"
    local shuffle="${2}"
    local path="${default_plpath}/${file}"
    # if the file is not in default path, then its a full path
    [ ! -f "${path}" ] && path="${file}"

    local links="$(cat ${path})"

    # shuffle if necessary
    [ ${shuffle} ] && links=$(echo "${links}" | shuf)

    for link in ${links}; do
        local title="$(youtube-dl -e ${link})"
        echo "${title}" > /tmp/ytpl_title
        notify-send "now playing" "${title}"
        link="$(echo "${link}" | sed -E 's/http(s)/ytdl/')"
        mpv ${link} --no-video --input-ipc-server=${socket}
    done

    unset link
    rm -rf ${socket} /tmp/ytpl_title
}

pause() {
    local is_paused="$(get_prop "\"pause\"")"

    case "${is_paused}" in
        *true*) set_prop "\"pause\", false";;
        *false*) set_prop "\"pause\", true";;
    esac
}

skip() {
    local time_duration=$(echo `get_prop "\"duration\""` | grep -oE '[0-9.]+')

    set_prop "\"time-pos\", ${time_duration}"
}

while [ $# -gt 0 ]; do
    case ${1} in
        play)
            if [ -S ${socket} ]  && [ -n $(pgrep -x mpv) ]; then
                echo 'mpv already playing!' && exit 0
            fi
           shift
           [ "${1}" = "shuffle" ] && { shuff=true; shift; } || shuff=false
           play "${1}" "${shuff}";;
        pause) pause;;
        skip) skip;;
        die|end) rm -rf ${socket} /tmp/ytpl_title && pkill -15 mpv && exit;;
    esac
    shift
done
