#!/bin/dash
# ls and cd in dmenu
# -h 1 = hide dotfiles

case "$1" in
    -h) hidden=$2;;
    *) hidden=1;;
esac

get_dir() {
    case "$hidden" in
        1)
            echo "..\n$(ls -w $(ls $pwd | wc -l) $pwd)" | menu sel;;
        0)
            echo "..\n$(ls -Aw $(ls -A $pwd | wc -l) $pwd)" | menu sel;;
    esac
}

cd_dir() {
    cd "$1"
    spawn
}

open_file() {
    # get the mime type of the file
    file_type="$(file -ib "$1")"

    case "$file_type" in
        *pdf*) mupdf "$1";;
        *image*) feh "$1";;
        *video*) mpv "$1";;
        *text*) "$TERMINAL" $EDITOR "$1";;
        *binary*) sh "$1";;
    esac
}

spawn() {
    output="$(get_dir)"

    if [ -d "$output" ]; then
        cd_dir "$output"
    elif [ -f "$output" ]; then
        open_file "$output"
    elif [ "$output" = ot ] || [ "$output" = "open terminal" ]; then
        $TERMINAL
    fi
}

spawn
