#!/bin/dash
# ls and cd in dmenu
# -h 1 = hide dotfiles

case $1 in
    -h) hidden=$2;;
    *) hidden=1;;
esac

ls() {
    local result
    local i
    for i in *; do
        [ -d "${i}" ] && i="${i}/"
        result="${result}\n${i}"
    done

    echo $result
}

cwd() {
    current_dir="$PWD"
    current_dir=`echo "$PWD" | sed -e "s|$HOME|~|"`
    echo "${current_dir} "
}

get_dir() {
    case $hidden in
        1)
            echo "..$(ls)" | menu sel -p "$(cwd)";;
        0)
            echo "..$(ls)" | menu sel -p "$(cwd)";;
    esac
}

cd_dir() {
    cd "$1"
    spawn
}

open_file() {
    # get the mime type of the file
    local file_type="$(file -ib "$1")"

    case $file_type in
        (*pdf*) mupdf "$1";;
        (*image*) feh "$1";;
        (*video*) mpv "$1";;
        (*text*) "$TERMINAL" $EDITOR "$1";;
        (*) case $(file "$1") in (*archive*) st -e upkp "$1"; notify-send "asd";; esac;;
    esac
}

spawn() {
    local output="$(get_dir)"

    if [ -d "$output" ]; then
        cd_dir "$output"
    elif [ -f "$output" ]; then
        open_file "$output"
    elif [ "$output" = ot ] || [ "$output" = "open terminal" ]; then
        $TERMINAL
    fi
}

spawn
